{% extends 'index.html' %}
{% load static %}

{% block title %} <title>Maap Creation</title> {% endblock title %}

{% block body %}

<div class="container mt-3 p-2" style="background-color: #fff; border-radius: 8px;">

    <!-- ✅ enctype ADDED for image upload -->
    <form action="" method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <button class="nav-link {% if active_tab == 'upper' %}active{% endif %}"
                        id="nav-home-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#nav-home"
                        type="button"
                        role="tab"
                        aria-selected="{% if active_tab == 'upper' %}true{% else %}false{% endif %}">
                    Upper Maap
                </button>

                <button class="nav-link {% if active_tab == 'lower' %}active{% endif %}"
                        id="nav-profile-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#nav-profile"
                        type="button"
                        role="tab"
                        aria-selected="{% if active_tab == 'lower' %}true{% else %}false{% endif %}">
                    Lower Maap
                </button>
            </div>
        </nav>

        <div class="tab-content" id="nav-tabContent">

            <!-- ======================= UPPER MAAP TAB ======================= -->
            <div class="tab-pane fade {% if active_tab == 'upper' %}show active{% endif %}"
                 id="nav-home"
                 role="tabpanel">

                <div class="table-responsive mt-2">
                    {{ upper_formset.management_form }}

                    <table class="table table-sm maapTable table-bordered">
                        <thead>
                            <tr>
                                <th>Upper Maap</th>
                                <th>Length</th>
                                <th>Shoulder</th>
                                <th>Sleeve</th>
                                <th>Chest</th>
                                <th>Lower Chest</th>
                                <th>Stomach</th>
                                <th>Hip</th>
                                <th>Neck</th>
                                <th>Other Remark</th>
                                <th>Design Image</th>
                                <th>Actions</th>
                            </tr>
                        </thead>

                        <tbody id="uppermaapBody">
                            {% for form in upper_formset %}
                            <tr>
                                <td>{{ form.upper_maap }}</td>
                                <td>{{ form.upper_length }}</td>
                                <td>{{ form.upper_shoulder }}</td>

                                <td>
                                    {{ form.upper_sleeve_length }}
                                    {{ form.upper_sleeve_bicep }}
                                    {{ form.upper_sleeve_cuff }}
                                </td>

                                <td>
                                    {{ form.upper_chest_body }}
                                    {{ form.upper_chest_ready }}
                                </td>

                                <td>
                                    {{ form.upper_lowerchest_body }}
                                    {{ form.upper_lowerchest_ready }}
                                </td>

                                <td>
                                    {{ form.upper_stomach_body }}
                                    {{ form.upper_stomach_ready }}
                                </td>

                                <td>
                                    {{ form.upper_hip_body }}
                                    {{ form.upper_hip_ready }}
                                </td>

                                <td>{{ form.upper_neck }}</td>
                                <td>{{ form.upper_other_remark }}</td>

                                <!-- ✅ IMAGE FIELD -->
                                <td>
                                    {{ form.upper_design_image }}

                                    {% if form.instance.upper_design_image %}
                                        <div class="mt-1">
                                            <a href="{{ form.instance.upper_design_image.url }}" target="_blank">
                                                View
                                            </a>
                                        </div>

                                        <img src="{{ form.instance.upper_design_image.url }}"
                                             alt="Upper Design"
                                             style="width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #ccc;"
                                             class="mt-1">
                                    {% endif %}
                                </td>

                                <td style="vertical-align: middle !important;">
                                    <button type="button" class="upperMaapDeleteBtn"
                                            style="border: none; background-color: transparent;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="red"
                                             class="bi bi-trash3" viewBox="0 0 16 16">
                                            <path
                                                d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5" />
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <button type="button" class="create-button" id="addRowBtn">Add More</button>
                </div>

                <hr>
            </div>

            <!-- ======================= LOWER MAAP TAB ======================= -->
            <div class="tab-pane fade {% if active_tab == 'lower' %}show active{% endif %}"
                 id="nav-profile"
                 role="tabpanel">

                <div class="table-responsive mt-2">
                    {{ lower_formset.management_form }}

                    <table class="table table-sm maapTable table-bordered">
                        <thead>
                            <tr>
                                <th>Lower Maap</th>
                                <th>Length</th>
                                <th>Waist</th>
                                <th>Hip</th>
                                <th>Thai</th>
                                <th>Knee</th>
                                <th>Bottom</th>
                                <th>Jhola</th>
                                <th>Other Remark</th>
                                <th>Design Image</th>
                                <th>Actions</th>
                            </tr>
                        </thead>

                        <tbody id="lowermaapBody">
                            {% for form in lower_formset %}
                            <tr>
                                <td>{{ form.lower_maap }}</td>
                                <td>{{ form.lower_length }}</td>
                                <td>{{ form.lower_waist }}</td>
                                <td>{{ form.lower_hip }}</td>
                                <td>{{ form.lower_thai }}</td>
                                <td>{{ form.lower_knee }}</td>
                                <td>{{ form.lower_bottom }}</td>
                                <td>{{ form.lower_jhola }}</td>
                                <td>{{ form.lower_other_remark }}</td>

                                <!-- ✅ IMAGE FIELD -->
                                <td>
                                    {{ form.lower_design_image }}

                                    {% if form.instance.lower_design_image %}
                                        <div class="mt-1">
                                            <a href="{{ form.instance.lower_design_image.url }}" target="_blank">
                                                View
                                            </a>
                                        </div>

                                        <img src="{{ form.instance.lower_design_image.url }}"
                                             alt="Lower Design"
                                             style="width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #ccc;"
                                             class="mt-1">
                                    {% endif %}
                                </td>

                                <td style="vertical-align: middle !important;">
                                    <button type="button" class="lowerMaapDeleteBtn"
                                            style="border: none; background-color: transparent;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="red"
                                             class="bi bi-trash3" viewBox="0 0 16 16">
                                            <path
                                                d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5" />
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <button type="button" class="create-button" id="addLowerMaapBtn">Add More</button>
                </div>

                <hr>
            </div>

        </div>

        <div class="w-100 d-flex">
            <button type="submit" class="create-button ms-auto me-3">Submit</button>
        </div>

    </form>

</div>

<script>
    document.getElementById('addRowBtn').addEventListener('click', function () {
        addRow('uppermaapBody', 'id_upper-TOTAL_FORMS');
    });

    document.getElementById('addLowerMaapBtn').addEventListener('click', function () {
        addRow('lowermaapBody', 'id_lower-TOTAL_FORMS');
    });

    function addRow(tbodyId, totalFormsId) {
        const tbody = document.getElementById(tbodyId);
        const totalForms = document.getElementById(totalFormsId);
        const formCount = parseInt(totalForms.value, 10);

        const newRow = tbody.firstElementChild.cloneNode(true);

        newRow.querySelectorAll('input, select, textarea').forEach(input => {
            input.name = input.name.replace(/-\d+-/, `-${formCount}-`);
            input.id = input.id.replace(/-\d+-/, `-${formCount}-`);

            // ✅ file input safe reset
            if (input.type === "file") {
                input.value = null;
            } else {
                input.value = '';
            }
        });

        // ✅ Remove preview image in cloned row (if exists)
        const imgs = newRow.querySelectorAll('img');
        imgs.forEach(img => img.remove());

        const links = newRow.querySelectorAll('a');
        links.forEach(a => a.remove());

        tbody.appendChild(newRow);
        totalForms.value = formCount + 1;
    }

    document.addEventListener('click', function (event) {

        // Lower delete
        if (event.target.closest('.lowerMaapDeleteBtn')) {
            const row = event.target.closest('tr');
            const tbody = document.getElementById('lowermaapBody');
            const totalForms = document.getElementById('id_lower-TOTAL_FORMS');

            if (tbody.children.length > 1) {
                row.remove();
                totalForms.value = tbody.children.length;
            } else {
                alert("At least one row must remain.");
            }
        }

        // Upper delete
        if (event.target.closest('.upperMaapDeleteBtn')) {
            const row = event.target.closest('tr');
            const tbody = document.getElementById('uppermaapBody');
            const totalForms = document.getElementById('id_upper-TOTAL_FORMS');

            if (tbody.children.length > 1) {
                row.remove();
                totalForms.value = tbody.children.length;
            } else {
                alert("At least one row must remain.");
            }
        }
    });
</script>

{% endblock body %}
